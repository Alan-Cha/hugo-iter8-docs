<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.74.3"><meta name=description content="Robust analytics and control to unleash cloud-native continuous experimentation."><meta name=author content="Alan Cha"><link rel=icon href=/hugo-iter8-docs/images/favicon.png type=image/png><title>Getting started with canary testing :: iter8 Documentation</title><link href=/hugo-iter8-docs/css/nucleus.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/fontawesome-all.min.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/hybrid.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/featherlight.min.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/perfect-scrollbar.min.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/auto-complete.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/atom-one-dark-reasonable.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/theme.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/hugo-theme.css?1596187958 rel=stylesheet><link href=/hugo-iter8-docs/css/theme-mine.css?1596187958 rel=stylesheet><script src=/hugo-iter8-docs/js/jquery-3.3.1.min.js?1596187958></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=/hugo-iter8-docs/tutorials/canary/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://alan-cha.github.io/hugo-iter8-docs/><img src=/hugo-iter8-docs/images/logo.png></a></div><a href=/hugo-iter8-docs/releases/>v1.0.0</a><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/hugo-iter8-docs/js/lunr.min.js?1596187958></script><script type=text/javascript src=/hugo-iter8-docs/js/auto-complete.js?1596187958></script><script type=text/javascript>var baseurl="https:\/\/alan-cha.github.io\/hugo-iter8-docs\/";</script><script type=text/javascript src=/hugo-iter8-docs/js/search.js?1596187958></script></div><div class=highlightable><ul class=topics><li data-nav-id=/hugo-iter8-docs/introduction/ title=Introduction class=dd-item><a href=/hugo-iter8-docs/introduction/>Introduction</a><ul><li data-nav-id=/hugo-iter8-docs/introduction/about/ title="Iter8 enables statistically robust continuous experimentation of microservices in your CI/CD pipelines" class=dd-item><a href=/hugo-iter8-docs/introduction/about/>About</a></li><li data-nav-id=/hugo-iter8-docs/introduction/installation/ title=Installation class=dd-item><a href=/hugo-iter8-docs/introduction/installation/>Installation</a><ul><li data-nav-id=/hugo-iter8-docs/introduction/installation/kubernetes/ title="Iter8 on Kubernetes and Istio" class=dd-item><a href=/hugo-iter8-docs/introduction/installation/kubernetes/>Kubernetes</a></li><li data-nav-id=/hugo-iter8-docs/introduction/installation/red-hat/ title="Iter8 on Red Hat OpenShift" class=dd-item><a href=/hugo-iter8-docs/introduction/installation/red-hat/>Red Hat OpenShift</a></li></ul></li></ul></li><li data-nav-id=/hugo-iter8-docs/reference/ title=Reference class=dd-item><a href=/hugo-iter8-docs/reference/>Reference</a><ul><li data-nav-id=/hugo-iter8-docs/reference/metrics/ title="Iter8's metrics" class=dd-item><a href=/hugo-iter8-docs/reference/metrics/>Metrics</a></li><li data-nav-id=/hugo-iter8-docs/reference/experiment/ title="Iter8's experiment CRD" class=dd-item><a href=/hugo-iter8-docs/reference/experiment/>Experiment</a></li><li data-nav-id=/hugo-iter8-docs/reference/algorithms/ title="Iter8's algorithms" class=dd-item><a href=/hugo-iter8-docs/reference/algorithms/>Algorithms</a></li></ul></li><li data-nav-id=/hugo-iter8-docs/tutorials/ title=Tutorials class="dd-item
parent"><a href=/hugo-iter8-docs/tutorials/>Tutorials</a><ul><li data-nav-id=/hugo-iter8-docs/tutorials/canary/ title="Getting started with canary testing" class="dd-item active"><a href=/hugo-iter8-docs/tutorials/canary/>Canary testing</a></li></ul></li><li data-nav-id=/hugo-iter8-docs/releases/ title="Older releases" class=dd-item><a href=/hugo-iter8-docs/releases/>Older releases</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/iter8-tools/iter8><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href=https://join.slack.com/t/iter8-tools/shared_invite/enQtODU0NTczMTQ5NDU4LTJmNGE1OTBhOWI4NzllZGE0ZjdhM2M3MzJlMjcxYjliMTJlM2YxMzQ4OWQ5NGViYTM2MTU4MWRkZTgxNzZiMzg><i class="fab fa-fw fa-slack"></i>Slack workspace</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/iter8-tools/docs/edit/master/content/tutorials/canary.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/hugo-iter8-docs/>Homepage</a> > <a href=/hugo-iter8-docs/tutorials/>Tutorials</a> > Getting started with canary testing</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#deploy-the-bookinfo-application>Deploy the Bookinfo application</a></li><li><a href=#expose-the-bookinfo-application>Expose the Bookinfo application</a></li><li><a href=#verify-access-to-bookinfo>Verify access to Bookinfo</a></li><li><a href=#generate-load>Generate load</a></li><li><a href=#create-a-canary-experiment>Create a canary <code>Experiment</code></a></li><li><a href=#deploy-the-candidate-version-of-the-_reviews_-service>Deploy the candidate version of the <em>reviews</em> service</a></li><li><a href=#cleanup>Cleanup</a></li><li><a href=#other-things-to-try-before-cleanup>Other things to try (before cleanup)</a><ul><li><a href=#inspect-progress-using-grafana>Inspect progress using Grafana</a></li><li><a href=#inspect-progress-using-kiali>Inspect progress using Kiali</a></li><li><a href=#alter-the-duration-of-the-experiment>Alter the duration of the experiment</a></li><li><a href=#try-a-version-that-fails-the-criteria>Try a version that fails the criteria</a></li><li><a href=#try-a-version-which-returns-errors>Try a version which returns errors</a></li><li><a href=#try-with-a-user-facing-service>Try with a user-facing service</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Getting started with canary testing</h1><p>This tutorial shows how <em>iter8</em> can be used to perform a canary release by gradually shifting traffic from one version of a microservice to another while evaluating the behavior of the new version.
Traffic is fully shifted only if the behavior the candidate version meets specified acceptance criteria.</p><p>This tutorial has seven steps, which are meant to be tried in order.
You will learn:</p><ul><li>how to perform a canary rollout with iter8; and</li><li>how to define different success criteria for iter8 to analyze canary releases and determine success or failure;</li></ul><p>The tutorial is based on the <a href=https://istio.io/docs/examples/bookinfo/>Bookinfo sample application</a> distributed with <a href=https://istio.io>Istio</a>.
This application comprises 4 microservies: <em>productpage</em>, <em>details</em>, <em>reviews</em>, and <em>ratings</em>.
Of these, <em>productpage</em> is a user-facing service while the others are backend services.</p><p>This tutorial assumes you have already installed <em>iter8</em> (including Istio). If not, do so using the instructions <a href=INSALL.md>here</a>.</p><h2 id=deploy-the-bookinfo-application>Deploy the Bookinfo application</h2><p>To deploy the Bookinfo application, create a namespace configured to enable auto-injection of the Istio sidecar. You can use whatever namespace name you wish. By default, the namespace <code>bookinfo-iter8</code> is created.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export NAMESPACE<span style=color:#f92672>=</span>bookinfo-iter8
curl -s https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/namespace.yaml <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  | sed <span style=color:#e6db74>&#34;s#bookinfo-iter8#</span>$NAMESPACE<span style=color:#e6db74>#&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  | kubectl apply -f -
</code></pre></div><p>Next, deploy the application:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE apply -f https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/bookinfo-tutorial.yaml
</code></pre></div><p>You should see pods for each of the four microservices:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE get pods
</code></pre></div><p>Note that we deployed version <em>v2</em> of the <em>reviews</em> microsevice; that is, <em>reviews-v2</em>.
Each pod should have two containers, since the Istio sidecar was injected into each.</p><h2 id=expose-the-bookinfo-application>Expose the Bookinfo application</h2><p>Expose the Bookinfo application by defining an Istio <code>Gateway</code> and <code>VirtualService</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE apply -f https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/bookinfo-gateway.yaml
</code></pre></div><p>You can inspect the created resources:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE get gateway,virtualservice
</code></pre></div><p>Note that the service has been associated with a fake host, <code>bookinfo.example.com</code> for demonstration purposes.</p><h2 id=verify-access-to-bookinfo>Verify access to Bookinfo</h2><p>To access the application, determine the ingress IP and port for the application.
You can do so by following steps 3 and 4 of the Istio instructions <a href=https://istio.io/latest/docs/examples/bookinfo/#determine-the-ingress-ip-and-port>here</a> to set the environment variables <code>GATEWAY_URL</code>. You can then check if you can access the application with the following <code>curl</code> command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl --header <span style=color:#e6db74>&#39;Host: bookinfo.example.com&#39;</span> -o /dev/null -s -w <span style=color:#e6db74>&#34;%{http_code}\n&#34;</span> <span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>${</span>GATEWAY_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/productpage&#34;</span>
</code></pre></div><p>If everything is working, the command above should return <code>200</code>.
Note that the curl command above sets the <code>Host</code> header to match the host we associated the VirtualService with (<code>bookinfo.example.com</code>).</p><p><strong>Note</strong>: If you want to access the application from your browser, you will need to set this header using a browser plugin.</p><h2 id=generate-load>Generate load</h2><p>To simulate user requests, use a command such as the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>watch -n 0.1 <span style=color:#e6db74>&#39;curl --header &#34;Host: bookinfo.example.com&#34; -s &#34;http://${GATEWAY_URL}/productpage&#34; | grep -i &#34;color=\&#34;&#34;&#39;</span>
</code></pre></div><p>This command requests the <code>productpage</code> microservice 10 times per second.
In turn, this causes about the same frequency of requests against the backend microservice.
We filter the response to see the color being used to display the &ldquo;star&rdquo; rating of the application.
The color varies between versions giving us a visual way to distinguish between them.</p><h2 id=create-a-canary-experiment>Create a canary <code>Experiment</code></h2><p>We will now define a canary experiment to rollout version <em>v3</em> of the <em>reviews</em> application.
These versions are identical except for the color of the stars that appear on the page.
In version <em>v3</em> they are <em>red</em>.
This can be seen in the inspected in the output of the above <code>watch</code> command.
As version <em>v3</em> is rolled out, you should see the color change.</p><p>To describe a canary rollout, create an iter8 <code>Experiment</code> that identifies the original, or <em>baseline</em> version and the new, or <em>candidate</em> version and some evaluation criteria.
For example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: iter8.tools/v1alpha2
<span style=color:#66d9ef>kind</span>: Experiment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: reviews-v3-rollout
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>service</span>:
    <span style=color:#66d9ef>name</span>: reviews
    <span style=color:#66d9ef>baseline</span>: reviews-v2
    <span style=color:#66d9ef>candidates</span>: [ <span style=color:#e6db74>&#34;reviews-v3&#34;</span> ]
  <span style=color:#66d9ef>criteria</span>:
    - <span style=color:#66d9ef>metric</span>: iter8_mean_latency
      <span style=color:#66d9ef>threshold</span>:
        <span style=color:#66d9ef>type</span>: absolute
        <span style=color:#66d9ef>value</span>: <span style=color:#ae81ff>200</span>
  <span style=color:#66d9ef>duration</span>:
    <span style=color:#66d9ef>maxIterations</span>: <span style=color:#ae81ff>8</span>
    <span style=color:#66d9ef>interval</span>: 15s
  <span style=color:#66d9ef>trafficControl</span>:
    <span style=color:#66d9ef>maxIncrement</span>: <span style=color:#ae81ff>20</span>
</code></pre></div><p>In this example, the target of the experiment is the service <code>reviews</code>.
The baseline and candidate versions are specified using their <code>Deployment</code> names, <code>reviews_v2</code> and <code>reviews_v3</code>, respectively.
A single evaluation criteria is specified.
It requires that the measurements of the metric <code>iter8_mean_latency</code> should all return values less than <code>200</code> milliseconds.
The additional parameters control how long the experiment should run and how much traffic can be shifted to the new version in each interval. Details regarding these parameters are <a href=#alter-the-duration-of-the-experiment>here</a>.</p><p>The experiment can be created using the command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE apply -f https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/canary_reviews-v2_to_reviews-v3.yaml
</code></pre></div><p>Inspection of the new experiment shows that it is paused because the specified candidate version cannot be found in the cluster:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE get experiment

NAME                 TYPE     HOSTS       PHASE   WINNER FOUND   CURRENT BEST   STATUS
reviews-v3-rollout   Canary   <span style=color:#f92672>[</span>reviews<span style=color:#f92672>]</span>   Pause                                 TargetsError: Missing Candidate
</code></pre></div><p>Once the candidate version is deployed, the experiment will start automatically.</p><h2 id=deploy-the-candidate-version-of-the-_reviews_-service>Deploy the candidate version of the <em>reviews</em> service</h2><p>To deploy version <em>v3</em> of the <em>reviews</em> microservice, execute:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE apply -f https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/reviews-v3.yaml
</code></pre></div><p>Once its corresponding pods have started, the <code>Experiment</code> will show that it is progressing:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE get experiment

NAME                 TYPE     HOSTS       PHASE         WINNER FOUND   CURRENT BEST   STATUS
reviews-v3-rollout   Canary   <span style=color:#f92672>[</span>reviews<span style=color:#f92672>]</span>   Progressing   false          reviews-v3     IterationUpdate: Iteration 0/8 completed
</code></pre></div><p>At approximately 15 second intervals, you should see the interation number change. Traffic will gradually be shifted (in 20% increments) from version <em>v2</em> to version <em>v3</em>.
iter8 will quickly identify that the best version is the candidate, <code>reviews-v3</code> and that it is confident that this choice will be the final choice (by indicating that a <em>winner</em> has been found:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE get experiment

NAME                 TYPE     HOSTS       PHASE         WINNER FOUND   CURRENT BEST   STATUS
reviews-v3-rollout   Canary   <span style=color:#f92672>[</span>reviews<span style=color:#f92672>]</span>   Progressing   true           reviews-v2     IterationUpdate: Iteration 3/8 completed
</code></pre></div><p>When the experiment is finished (about 2 minutes), you will see that all traffic has been shifted to the winner, <em>reviews-v3</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --namespace $NAMESPACE get experiment

NAME                 TYPE     HOSTS       PHASE       WINNER FOUND   CURRENT BEST   STATUS
reviews-v3-rollout   Canary   <span style=color:#f92672>[</span>reviews<span style=color:#f92672>]</span>   Completed   true           reviews-v3     ExperimentCompleted: Traffic To Winner
</code></pre></div><h2 id=cleanup>Cleanup</h2><p>To clean up, delete the namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete namespace $NAMESPACE
</code></pre></div><h2 id=other-things-to-try-before-cleanup>Other things to try (before cleanup)</h2><h3 id=inspect-progress-using-grafana>Inspect progress using Grafana</h3><p>Coming soon</p><h3 id=inspect-progress-using-kiali>Inspect progress using Kiali</h3><p>Coming soon</p><h3 id=alter-the-duration-of-the-experiment>Alter the duration of the experiment</h3><p>The progress of an experiment can be impacted by <code>duration</code> and <code>trafficControl</code> parameters:</p><ul><li><code>duration.interval</code> defines how long each test interval should be (<em>default: 30 seconds</em>)</li><li><code>duration.maxIterations</code> identifies what the maximum number of iterations there should be (<em>default: 100</em>)</li><li><code>trafficControl.maxIncrement</code> identifies the largest change (increment) that will be made in the percentage of traffic sent to a candidate (<em>default: 2 percent</em>)</li></ul><p>The impact of the first two parameters on the duration of the experiment are clear.
Restricting the size of traffic shifts limits how quickly an experiment can come to a decision about a candidate.</p><h3 id=try-a-version-that-fails-the-criteria>Try a version that fails the criteria</h3><p>Version <em>v4</em> of the <em>reviews</em> service is a modification that returns after a 5 second delay.
If you try this version as a candidate, you should see the canary experiment reject it and choose the baseline version as the winner.</p><p>For your reference:</p><ul><li>A YAML for the deployment <code>reviews-v4</code> is: <a href=https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/reviews-v4.yaml>https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/reviews-v4.yaml</a></li><li>A YAML for an canary experiment from <em>reviews-v3</em> to <em>reviews-v4</em> is: <a href=https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/canary_reviews-v3_to_reviews-v4.yaml>https://raw.githubusercontent.com/Alan-Cha/hugo-iter8-docs/master/static/tutorials/canary_reviews-v3_to_reviews-v4.yaml</a></li></ul><h3 id=try-a-version-which-returns-errors>Try a version which returns errors</h3><p>Coming soon</p><h3 id=try-with-a-user-facing-service>Try with a user-facing service</h3><p>Coming soon</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/hugo-iter8-docs/js/clipboard.min.js?1596187958></script><script src=/hugo-iter8-docs/js/perfect-scrollbar.min.js?1596187958></script><script src=/hugo-iter8-docs/js/perfect-scrollbar.jquery.min.js?1596187958></script><script src=/hugo-iter8-docs/js/jquery.sticky.js?1596187958></script><script src=/hugo-iter8-docs/js/featherlight.min.js?1596187958></script><script src=/hugo-iter8-docs/js/highlight.pack.js?1596187958></script><script>hljs.initHighlightingOnLoad();</script><script src=/hugo-iter8-docs/js/modernizr.custom-3.6.0.js?1596187958></script><script src=/hugo-iter8-docs/js/learn.js?1596187958></script><script src=/hugo-iter8-docs/js/hugo-learn.js?1596187958></script><link href=/hugo-iter8-docs/mermaid/mermaid.css?1596187958 rel=stylesheet><script src=/hugo-iter8-docs/mermaid/mermaid.js?1596187958></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>